<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify OAuth Callback - Neural Bard</title>
    <link rel="icon" type="image/svg+xml" href="../../favicon.svg">
    <link rel="icon" type="image/x-icon" href="../../favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .callback-container {
            max-width: 500px;
            text-align: center;
        }
        .spinner-border {
            color: #1db954;
        }
        .alert {
            border-radius: 12px;
        }
        .btn-spotify {
            background-color: #1db954;
            border-color: #1db954;
            color: #000000;
            font-weight: 600;
        }
        .btn-spotify:hover {
            background-color: #1ed760;
            border-color: #1ed760;
            color: #000000;
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div class="mb-4">
            <i class="fab fa-spotify fa-3x text-success mb-3"></i>
            <h2>Connecting to Spotify...</h2>
        </div>
        
        <div id="loading" class="text-center">
            <div class="spinner-border mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Processing your Spotify authorization...</p>
        </div>
        
        <div id="success" class="alert alert-success" style="display: none;">
            <i class="fas fa-check-circle me-2"></i>
            <strong>Success!</strong> Connected to Spotify successfully.
            <p class="mb-2 mt-2">You can now create playlists with Neural Bard! Redirecting to get started...</p>
            <p class="small text-muted mb-3">Redirecting automatically in <span id="countdown">5</span> seconds...</p>
            <div class="mt-3">
                <button class="btn btn-spotify" onclick="redirectToMain()">
                    <i class="fas fa-music me-2"></i>Continue to Neural Bard
                </button>
            </div>
        </div>
        
        <div id="error" class="alert alert-danger" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error!</strong> <span id="errorMessage">Failed to connect to Spotify.</span>
            <div class="mt-3">
                <button class="btn btn-outline-light" onclick="retryAuth()">
                    <i class="fas fa-redo me-2"></i>Try Again
                </button>
                <button class="btn btn-outline-secondary ms-2" onclick="redirectToMain()">
                    <i class="fas fa-home me-2"></i>Back to Main
                </button>
            </div>
        </div>
    </div>

    <script>
        // Spotify OAuth Callback Handler
        class SpotifyCallback {
            constructor() {
                this.clientId = '62d4eb4142784c7d9e0a3a1f0b1976ee';
                // Use appropriate callback URI based on environment
                if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
                    this.redirectUri = 'https://localhost:3000/auth/callback/';
                } else if (window.location.hostname === 'goseland.org') {
                    this.redirectUri = 'https://goseland.org/spotify-llm-driven-playlist/auth/callback/';
                } else {
                    this.redirectUri = 'https://spotify-llm-driven-playlist.netlify.app/auth/callback/';
                }
                this.init();
            }

            init() {
                console.log('Spotify OAuth Callback initialized');
                this.handleCallback();
            }

            handleCallback() {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const error = urlParams.get('error');
                const state = urlParams.get('state');

                console.log('Callback parameters:', { code: !!code, error, state });

                if (error) {
                    this.handleError(error);
                    return;
                }

                if (code) {
                    this.exchangeCodeForToken(code, state);
                } else {
                    this.handleError('No authorization code received');
                }
            }

            async exchangeCodeForToken(code, state) {
                try {
                    console.log('Exchanging code for token...');
                    
                    // Call real Spotify token exchange - use Netlify endpoint for non-Netlify hosts
                    const apiUrl = window.location.hostname === 'spotify-llm-driven-playlist.netlify.app'
                        ? '/.netlify/functions/spotify-token-exchange'
                        : 'https://spotify-llm-driven-playlist.netlify.app/.netlify/functions/spotify-token-exchange';
                    
                    console.log('Token exchange API URL:', apiUrl);
                    console.log('Request body:', {
                        code: code,
                        redirectUri: this.redirectUri
                    });
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            code: code,
                            redirectUri: this.redirectUri
                        })
                    });
                    
                    if (!response.ok) {
                        console.error('Token exchange failed with status:', response.status);
                        let errorMessage = 'Token exchange failed';
                        try {
                            const errorData = await response.json();
                            console.error('Error response:', errorData);
                            errorMessage = errorData.error || errorMessage;
                        } catch (e) {
                            console.error('Could not parse error response:', e);
                        }
                        throw new Error(errorMessage);
                    }
                    
                    const tokenData = await response.json();
                    
                    if (tokenData.success) {
                        this.handleSuccess(tokenData);
                    } else {
                        this.handleError(tokenData.error || 'Token exchange failed');
                    }
                } catch (error) {
                    console.error('Token exchange error:', error);
                    this.handleError('Failed to exchange code for token: ' + error.message);
                }
            }


            handleSuccess(response) {
                console.log('Spotify connection successful:', response);
                
                // Store token in localStorage (in production, use secure storage)
                localStorage.setItem('spotify_access_token', response.accessToken);
                localStorage.setItem('spotify_refresh_token', response.refreshToken);
                localStorage.setItem('spotify_token_expires', Date.now() + (response.expiresIn * 1000));
                
                // Show success message
                document.getElementById('loading').style.display = 'none';
                document.getElementById('success').style.display = 'block';
                
                // Start countdown timer
                let countdown = 5;
                const countdownElement = document.getElementById('countdown');
                const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdownElement) {
                        countdownElement.textContent = countdown;
                    }
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                    }
                }, 1000);
                
                // Show success notification, wait 2 seconds, then auto-redirect after 3 more seconds
                setTimeout(() => {
                    clearInterval(countdownInterval);
                    // Store a flag to show success toast on main page
                    localStorage.setItem('spotify_connection_success', 'true');
                    redirectToMain();
                }, 5000); // Total 5 seconds: 2s to show success + 3s countdown
            }

            handleError(errorMessage) {
                console.error('Spotify connection error:', errorMessage);
                
                // Show error message
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('errorMessage').textContent = errorMessage;
            }
        }

        // Utility functions
        function redirectToMain() {
            // Redirect to the main page in the same directory structure
            const mainPageUrl = window.location.origin + window.location.pathname.replace('/auth/callback/', '/');
            window.location.href = mainPageUrl;
        }

        function retryAuth() {
            // Redirect back to Spotify auth
            const authUrl = `https://accounts.spotify.com/authorize?` +
                `client_id=${new SpotifyCallback().clientId}&` +
                `response_type=code&` +
                `redirect_uri=${encodeURIComponent(new SpotifyCallback().redirectUri)}&` +
                `scope=playlist-modify-public playlist-modify-private&` +
                `state=${Date.now()}`;
            
            window.location.href = authUrl;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SpotifyCallback();
        });
    </script>
</body>
</html>

